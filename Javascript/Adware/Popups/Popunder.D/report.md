## Adware Script Report (JS:Adware.Popunder.D) 


### How, Where & Why?
Initially I was asked to analyse a shady redirect found by Angry_Pineapple which led me down a rabbit hole where I found that a minecraft alt service called 'BlazeAlts' redirects you to a ShrinkURL url to receive the alts, and then when on the ShrinkURL page appears to load the javascript from a domain and load it into the browser in order to serve the user the popups, along with that it then redirects you to a massive list of new URL redirects. These actions can be seen in the recreation video made by Angry_Pineapple <a href='https://cdn.discordapp.com/attachments/617542600144060416/799298762924228608/2021-01-14_10-26-23.mp4'>here.</a>
This leads me to think that ShrinkURL is using this adware to make money off of being a URL shortening service just like adfly & bitly.

A Sample AV Detection can be seen in Figure 5.

### Code Deobfuscation
After looking into the script's code, I saw that it was obfuscated to some sort of degree as seen in Figure 1.
I then attempted to deobfuscate the whole script which was initially around 77kB large, when deobfuscated it becomes 
around 40kB+. I researched the code I saw in the deobfuscated version, and noted that it was labelled as JS:Adware.Popunder.D by many AV engines, but what interested me was if I could figure out a YARA rule that would catch these sorts of scripts. So then I looked around many versions of this script for very distinct IOCs and compiled them into a list and tested them using a YARA rule which can be found in ``detect.yar`` file of this folder. 

### Code Analysis & Finding IOCs
The function at the end of the script executes a GET request to ``https://r.remarketingpixel.com/stats`` with a ``'withCredentials'`` boolean used in the ``XMLHttpRequest`` object, which then appears to get a random UUID from this website to use as a cookie value and then uses the hardcoded cookie key (``dom3ic8zudi28v8lr6fgphwffqoz0j6c``) being set by the website in question. There is also a function that detects what browser type the user is using along with checking if they have Chrome DevTools UI open. Another interesting find is that the ``executePop()`` function creates a new iframe element and then gives it an id starting with ``abyr_frame`` (as seen in Figure 2.) which lead me to believe this could be another distinct IOC as well as the previously mentioned cookie key. Furthermore the code also refers to a PDF hosted on a URL (ex. ``https://cdn15.acloudimages.com/36/template/pu1473410272.pdf``), seen in Figure 3, which appears to be copyrighted by a company called 'AdSupply', further research on this company gives me the idea that the ads sourced for the adware part of the script are from this company. The script also appears to mention the following strings as prefixes for the cookie names in the 'cookies' variable (in Figure 4.); 

- ppu_main
- ppu_exp
- ppu_clicks
- ppu_show_on
- ppu_sub
- ppu_delay
- ppu_idelay
- total_count

Which are another set of distinct IOCs across different versions of the script. Also the script refers to an advertisers.js file hosted on a seperate domain, which appears to be the same script described by this report.


### Reconnaissance
I then took all the IOCs found and tried to do some reconnaissance on them, and found that the cookie prefix mentioned for the random UUID retireval is used on many blogspot websites and is still active with the most recent usage being 13/01/2021 as seen <a href='https://tools.digitalpoint.com/cookie-search?name=dom3ic8zudi28v8lr6fgphwffqoz0j6c'>here</a>. With the most seen origin domain being ``hqq.tv`` and ``hqq.to``, when going to the aforementioned domains they both redirect to a website under the domain ``56.com`` which seems to be unrelated to the whole Adware script, however I could be wrong in thinking that. Moving on, the iframe ID found within the script's code, was found to be relating to many other variants of this script, seen across a varied array of domains, sometimes even found unobfuscated. As well as this just googling the PDF name gave me some hints at what this PDF could be in relation to the script as seen <a href='https://patrickhurd.pro/blog/posts/c6bjsanalysis.html'>here</a> explained by Patrick Hurd, however some the script he analysed is completely different to this one. Also appears that ``https://remarketingpixel.com/`` is owned by the Adsterra Network, so I would not be wrong to believe that the ads are provided by them, similarly as the AdSupply copyright on the PDF found, or may they are using each other's technology to beat each other in the ad marketing game as Patrick mentioned in his analysis.


### Further Actions
To remove this Adware I would recommend using an appropriate tool to do so, and if you want to have a YARA rule to detect this specific variant, then I would recommend using the attached <a href='https://github.com/IlluminatiFish/MalwareResearch/detect.yar'>YARA rule</a> written by myself using the IOCs found in my investigation. 





**Referred Figures (from 1 to 5):**

<a href="https://ibb.co/3sP6gmN"><img style='float: left;' src="https://i.ibb.co/3sP6gmN/Figure-1.png" alt="Figure-1" border="2"></a><a href="https://ibb.co/DwhFc3M"><img style='float: left;' src="https://i.ibb.co/DwhFc3M/Figure-2.png" alt="Figure-2" border="2"></a><a href="https://ibb.co/c20FrY9"><img style='float: left;' src="https://i.ibb.co/c20FrY9/Figure-3.png" alt="Figure-3" border="2"></a><a href="https://ibb.co/Y2rWT23"><img style='float: left;' src="https://i.ibb.co/Y2rWT23/Figure-4.png" alt="Figure-4" border="2"></a><a href="https://ibb.co/19jqXYz"><img src="https://i.ibb.co/19jqXYz/Figure-5.png" alt="Figure-5" border="0"></a>














